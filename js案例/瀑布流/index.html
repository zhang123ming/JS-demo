<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            border: none;
        }

        img {
            width: 165px;
            vertical-align: top;;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        #main {
            position: relative;
        }

        .box {
            float: left;
            padding: 15px 0 0 15px;
        }

        .pic {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #fff;
        }
    </style>
</head>
<body>
<div id="main">
    <div class="box">
        <div class="pic"><img src="1.jpg" style="height: 250px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="2.jpg" style="height: 150px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="3.jpg" style="height: 200px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="4.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="5.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="6.jpg" style="height: 250px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="7.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="8.jpg" style="height: 160px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="9.jpg" style="height: 198px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="10.jpg" style="height: 240px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 250px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="12.jpg" style="height: 190px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="13.jpg" style="height: 220px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="14.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="15.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="16.jpg" style="height: 205px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="17.jpg" style="height: 200px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 165px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="4.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="5.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="9.jpg" style="height: 198px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="10.jpg" style="height: 240px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 250px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="12.jpg" style="height: 190px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="13.jpg" style="height: 220px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="14.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="15.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="16.jpg" style="height: 205px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="17.jpg" style="height: 200px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 165px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="4.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="7.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="8.jpg" style="height: 160px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="9.jpg" style="height: 198px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="10.jpg" style="height: 240px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 250px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="12.jpg" style="height: 190px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="13.jpg" style="height: 220px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="14.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="15.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="16.jpg" style="height: 205px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="17.jpg" style="height: 200px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 165px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="4.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="5.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="9.jpg" style="height: 198px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="10.jpg" style="height: 240px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 250px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="12.jpg" style="height: 190px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="3.jpg" style="height: 200px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="4.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="5.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="6.jpg" style="height: 250px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="7.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="8.jpg" style="height: 160px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="9.jpg" style="height: 198px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="10.jpg" style="height: 240px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 250px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="12.jpg" style="height: 190px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="13.jpg" style="height: 220px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="14.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="15.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="16.jpg" style="height: 205px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="17.jpg" style="height: 200px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 165px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="4.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="5.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="9.jpg" style="height: 198px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="10.jpg" style="height: 240px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="11.jpg" style="height: 250px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="12.jpg" style="height: 190px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="13.jpg" style="height: 220px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="14.jpg" style="height: 230px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="15.jpg" style="height: 180px"></div>
    </div>
    <div class="box">
        <div class="pic"><img src="16.jpg" style="height: 205px"></div>
    </div>
</div>
<script src="Underscore.js"></script>
<script>
    window.onload = function () {
//    实现瀑布流布局
        waterFull("main", 'box');

        /**
         * 动态加载图片
         * */
        var timer2 = null;
        window.onscroll = function () {
            clearTimeout(timer2);
            timer2 = setTimeout(function () {
                if (checkWillLoadImage()) {
                    //造数据
                    var dataArr = [
                        {"src": "16.jpg"},
                        {"src": "13.jpg"},
                        {"src": "11.jpg"},
                        {"src": "12.jpg"},
                        {"src": "3.jpg"},
                        {"src": "8.jpg"},
                        {"src": "7.jpg"},
                        {"src": "6.jpg"},
                        {"src": "9.jpg"},
                        {"src": "1.jpg"},
                        {"src": "10.jpg"},
                        {"src": "12.jpg"},
                        {"src": "13.jpg"},
                        {"src": "15.jpg"}
                    ];
                    //    创建元素
                    for (var i = 0; i < dataArr.length; i++) {
                        var newBox = document.createElement('div');
                        newBox.className = 'box';//给div添加box
                        //追加到id为main中
                        $("main").appendChild(newBox);
                        //创建div
                        var newPic = document.createElement('div');
                        //添加类
                        newPic.className = 'pic';
                        //追加
                        newBox.appendChild(newPic);

                        var newImg = document.createElement('img');
                        newImg.src = dataArr[i].src;
                        newPic.appendChild(newImg);

                        //重新布局
                        waterFull("main", 'box');

                    }
                }
            }, 200)
        };

        /**临时添加代码 窗口发生改变时触发
         * 窗口大小发生改变
         * */
        var timer1 = null;
        window.onresize = function () {
            clearTimeout(timer1);
            //通过节流的方式控制用户频繁去操作所浪费的性能
            timer1 = setTimeout(function () {
                waterFull("main", 'box');
            }, 200)
        };

        /**
         *实现瀑布流布局
         * */
        function waterFull(parent, child) {
            //父级盒子居中
            //    第一步获取所有的盒子
            var allBox = $(parent).getElementsByClassName(child);
            //获取子盒子的宽度
            var boxWith = allBox[0].offsetWidth;
            // console.log(boxWith);
            //    获取屏幕的宽度
            var screenW = document.documentElement.clientWidth;
            // console.log(screenW);
            //    求出列数 屏幕的宽度/盒子的宽度 并且取整
            var cols = parseInt(screenW / boxWith);
            // console.log(cols);
            //父盒子居中 算法 列数*盒子的宽度
            $(parent).style.width = cols * boxWith + 'px';
            $(parent).style.margin = '0 auto';

            //    子盒子定位
            //    定义高度数组
            var heightArr = [];
            //每一个盒子的高度
            var boxHeight;
            //最矮盒子高度
            var minBoxHeight;
            //最小盒子索引
            var minBoxIndex = 0;
            //    遍历子盒子
            for (var i = 0; i < allBox.length; i++) {
                //求出每一个子盒子的高度
                boxHeight = allBox[i].offsetHeight;
                // console.log(boxHeight);
                //    取出第一行盒子的高度放入高度数组中
                if (i < cols) {//第一行  暂时未理解
                    heightArr.push(boxHeight);
                    allBox[i].style = null;//添加onresize后添加的代码
                } else {//剩余行
                    //    取出最矮的盒子高度
                    minBoxHeight = _.min(heightArr);
                    //    求出最矮盒子对应的索引
                    minBoxIndex = getMinBoxIndex(heightArr, minBoxHeight);
                    //子盒子定位
                    allBox[i].style.position = "absolute";
                    allBox[i].style.left = minBoxIndex * boxWith + 'px';
                    allBox[i].style.top = minBoxHeight + 'px';
                    //    更新数组中的高度
                    heightArr[minBoxIndex] += boxHeight;
                }
            }
            // console.log(minBoxIndex);//最小盒子的索引
            // console.log(heightArr, minBoxHeight);//获取最小盒子的大小
        }

        /**
         * 获取数组中最矮盒子的高度的索引
         * */
        function getMinBoxIndex(arr, val) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] === val) {
                    return i;
                }
            }
        }

        //id
        function $(id) {
            return typeof id === 'string' ? document.getElementById(id) : null;
        }

        /**
         * 鼠标滚动兼容
         *
         * */
        function scroll() {
            if (window.pageYOffset !== null) {
                return {
                    top: window.pageYOffset,
                    left: window.pageXOffset,
                }
            } else if (document.compatMode === "CSS1Compat") {
                //严格模式
                return {
                    top: document.documentElement.scrollLeft,
                    left: document.documentElement.scrollLeft,
                }
            }
            //怪异模式
            return {
                top: document.body.scrollTop,
                left: document.body.scrollLeft,
            }
        }

        /**
         * 是否具备加载条件
         * */
        function checkWillLoadImage() {
            //获取最后一个盒子
            var allBox = document.getElementsByClassName('box');
            var lastBox = allBox[allBox.length - 1];
            //    求出最后一个盒子自身高度的一半+offsetTop
            var lastBoxDis = lastBox.offsetHeight * 0.5 + lastBox.offsetTop;

            //    求出屏幕高度
            var screenW = document.body.clientHeight || document.documentElement.clientHeight;
            //    求出页面偏离浏览器的高度
            var scrollTop = scroll().top;
            return lastBoxDis <= screenW + scrollTop;
        }
    }
</script>
</body>
</html>